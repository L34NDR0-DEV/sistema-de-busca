document.addEventListener("DOMContentLoaded",function(){let a;try{a=L.map("mapContainer").setView([-21.3758,-46.5289],13),L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',maxZoom:19}).addTo(a),console.log("Mapa Leaflet (OpenStreetMap) inicializado com sucesso."),a.createPane("alternativeRoutePane"),a.getPane("alternativeRoutePane")?(a.getPane("alternativeRoutePane").style.zIndex=620,a.getPane("alternativeRoutePane").style.pointerEvents="auto"):console.error("Falha ao criar alternativeRoutePane"),a.createPane("primaryRoutePane"),a.getPane("primaryRoutePane")?(a.getPane("primaryRoutePane").style.zIndex=630,a.getPane("primaryRoutePane").style.pointerEvents="auto"):console.error("Falha ao criar primaryRoutePane")}catch(e){console.error("ERRO CRÍTICO AO INICIALIZAR O MAPA LEAFLET:",e);const n=document.getElementById("mapContainer");n&&(n.innerHTML='<p style="text-align:center; padding-top:50px; color:red;">Não foi possível carregar o mapa. Verifique o console (F12).</p>');return}const E=document.getElementById("origin_address"),x=document.getElementById("destination_address"),O=document.getElementById("origin_suggestions"),N=document.getElementById("destination_suggestions"),w=document.getElementById("setOriginByMapBtn"),M=document.getElementById("setDestinationByMapBtn"),f=document.getElementById("confirmAddressesBtn"),h=document.getElementById("error_message_input"),R=document.getElementById("input-panel"),A=document.getElementById("quote-details-panel"),U=document.getElementById("confirmed_origin_address_quote"),ee=document.getElementById("confirmed_destination_address_quote"),q=document.getElementById("category_select"),Q=document.getElementById("category_name_display"),v=document.getElementById("calculated_price_display"),j=document.getElementById("editAddressesBtnQuote"),_=document.getElementById("alternative-routes-info"),C=document.getElementById("showAlternativesBtn"),P=document.getElementById("error_message_quote"),H=document.getElementById("distance"),Z=document.getElementById("duration"),V=document.getElementById("spinner");let I=null;const te=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),ne=L.icon({iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-orange.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]}),oe=L.icon({iconUrl:"https://cdn-icons-png.flaticon.com/512/2972/2972481.png",iconSize:[24,24],iconAnchor:[12,24],popupAnchor:[0,-24]}),D=["#ff8c00","#00bcd4","#9c27b0","#ffeb3b","#4caf50"];let b=[],z=[],y=null,g=null,r=null,l=null,p=[];function S(e,n="Buscando informações..."){const o=V.querySelector(".spinner-text");if(o&&(o.textContent=n),V.style.display=e?"flex":"none",a){const t=document.getElementById("mapContainer");t&&(e?t.classList.add("blur"):t.classList.remove("blur"))}f.disabled=e,E.disabled=e,x.disabled=e,w.disabled=e,M.disabled=e,q.disabled=e,j.disabled=e,C.disabled=e}function G(e,n){let o;return function(...t){clearTimeout(o),o=setTimeout(()=>e.apply(this,t),n)}}function T(){a&&(H.textContent="---",Z.textContent="---",Q.textContent="---",v.textContent="R$ ---",v.classList.remove("price-changed"),P.textContent="",_.innerHTML="",C.style.display="none",b.forEach(e=>{a.hasLayer(e.polyline)&&a.removeLayer(e.polyline)}),b=[],z.forEach(e=>a.removeLayer(e)),z=[])}function W(e,n){e.classList.add("hidden-panel"),e.addEventListener("transitionend",function o(){e.style.display="none",e.removeEventListener("transitionend",o),n&&n()})}function J(e){e.style.display="flex",e.offsetWidth,e.classList.remove("hidden-panel")}function ae(){W(A,function(){J(R),T(),f.disabled=!(r&&l)})}function ie(){r&&l?W(R,function(){J(A),U.textContent=r.displayName||`${r.lat.toFixed(5)}, ${r.lon.toFixed(5)}`,ee.textContent=l.displayName||`${l.lat.toFixed(5)}, ${l.lon.toFixed(5)}`,T(),q.value="",h.textContent=""}):h.textContent="Por favor, defina origem e destino válidos."}j.addEventListener("click",ae),f.addEventListener("click",function(){r&&l?ie():h.textContent="Defina a origem e o destino antes de continuar."});async function K(e,n,o,t){if(e.length<3){n.innerHTML="",n.style.display="none",t==="origin"?(r=null,y&&a&&a.hasLayer(y)&&(a.removeLayer(y),y=null)):(l=null,g&&a&&a.hasLayer(g)&&(a.removeLayer(g),g=null)),f.disabled=!(r&&l),(!r||!l)&&(A.style.display="none",R.style.display==="none"&&A.style.display==="none"&&(R.style.display="flex"));return}n.innerHTML='<li class="loading-suggestion">Buscando...</li>',n.style.display="block";try{const i=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(e)}&addressdetails=1&countrycodes=br&limit=5`,s=await fetch(i);if(!s.ok)throw new Error("Falha na busca de sugestões");const u=await s.json();n.innerHTML="",u&&u.length>0?u.forEach(d=>{let m=d.address.road||"";d.address.house_number&&(m+=`, ${d.address.house_number}`);const B=d.address.city||d.address.town||d.address.village||d.address.suburb||"";B&&(m+=` - ${B}`),!m&&d.display_name&&(m=d.display_name.split(",").slice(0,3).join(","));const k=document.createElement("li");k.textContent=m,k.addEventListener("click",()=>{o.value=m;const c={lat:parseFloat(d.lat),lon:parseFloat(d.lon),displayName:m};t==="origin"?(r=c,F("origin",c.lat,c.lon,c.displayName)):(l=c,F("destination",c.lat,c.lon,c.displayName)),n.innerHTML="",n.style.display="none",f.disabled=!(r&&l)}),n.appendChild(k)}):n.innerHTML="<li>Nenhuma sugestão encontrada.</li>"}catch(i){console.error("Erro ao buscar sugestões:",i),n.innerHTML="<li>Erro ao buscar.</li>"}}E.addEventListener("input",G(function(){K(E.value,O,E,"origin")},500)),x.addEventListener("input",G(function(){K(x.value,N,x,"destination")},500)),document.addEventListener("click",function(e){!E.contains(e.target)&&!O.contains(e.target)&&!x.contains(e.target)&&!N.contains(e.target)&&(O.style.display="none",N.style.display="none")});async function se(e,n){S(!0,"Obtendo endereço do ponto...");try{const o=`https://nominatim.openstreetmap.org/reverse?format=json&lat=${e}&lon=${n}&addressdetails=1`,t=await fetch(o);if(!t.ok)throw new Error("Falha na geocodificação reversa");const i=await t.json();if(i&&i.display_name){let s=i.address.road||"";i.address.house_number&&(s+=`, ${i.address.house_number}`);const u=i.address.city||i.address.town||i.address.village||i.address.suburb||"";return u&&s?s+=` - ${u}`:u&&(s=u),s||i.display_name}else return`${e.toFixed(5)}, ${n.toFixed(5)}`}catch(o){return console.error("Erro na geocodificação reversa:",o),h.textContent="Não foi possível obter o endereço para o ponto clicado.",`${e.toFixed(5)}, ${n.toFixed(5)}`}finally{S(!1)}}function F(e,n,o,t){if(!a){console.error("Objeto map não inicializado em updateMapMarker");return}const i=e==="origin"?te:ne;let s=e==="origin"?y:g;s?s.setLatLng([n,o]).setPopupContent(`<b>${e==="origin"?"Origem":"Destino"}:</b><br>${t}`).update():(s=L.marker([n,o],{icon:i}).addTo(a).bindPopup(`<b>${e==="origin"?"Origem":"Destino"}:</b><br>${t}`),e==="origin"?y=s:g=s),a.flyTo([n,o],a.getZoom()<15?15:a.getZoom(),{duration:1}),s&&s.openPopup(),f.disabled=!(r&&l)}w.addEventListener("click",()=>{I="origin";const e=document.getElementById("mapContainer");e&&e.classList.add("crosshair-cursor"),w.classList.add("active-mode"),M.classList.remove("active-mode"),h.textContent="Clique no mapa para definir a ORIGEM."}),M.addEventListener("click",()=>{I="destination";const e=document.getElementById("mapContainer");e&&e.classList.add("crosshair-cursor"),M.classList.add("active-mode"),w.classList.remove("active-mode"),h.textContent="Clique no mapa para definir o DESTINO."}),a&&a.on("click",async function(e){if(!I)return;const{lat:n,lng:o}=e.latlng,t=await se(n,o),i={lat:n,lon:o,displayName:t};I==="origin"?(E.value=t,r=i,F("origin",n,o,t)):I==="destination"&&(x.value=t,l=i,F("destination",n,o,t));const s=document.getElementById("mapContainer");s&&s.classList.remove("crosshair-cursor"),w.classList.remove("active-mode"),M.classList.remove("active-mode"),h.textContent="",I=null,f.disabled=!(r&&l)}),q.addEventListener("change",function(){this.value&&r&&l?re(this.value):this.value||T()});function X(e){if(!e||!a)return;const n=parseFloat(v.textContent.replace("R$ ","").replace(",",".")),o=e.calculated_price;Q.textContent=e.category_name,H.textContent=e.distance_km,Z.textContent=e.duration_formatted,v.textContent=`${e.currency_symbol||"R$"} ${o.toFixed(2).replace(".",",")}`,n!==o&&(v.classList.remove("price-changed"),v.offsetWidth,v.classList.add("price-changed")),b.forEach(t=>{if(!a.hasLayer(t.polyline))return;const i=t.id===e.id;t.polyline.setStyle({weight:i?9:t.is_primary?7:5,opacity:i?1:t.is_primary?.95:.7}),i&&t.polyline.bringToFront()})}function Y(e,n=!1){if(!a){console.error("Objeto map não inicializado em drawRoutesOnMap");return}b.forEach(t=>{a.hasLayer(t.polyline)&&a.removeLayer(t.polyline)}),b=[];let o=L.latLngBounds([]);e.forEach((t,i)=>{const s=t.id||`route-idx-${Date.now()}-${i}`;if(t.id=s,t.geometry&&t.geometry.coordinates){const u=t.geometry.coordinates.map($=>[$[1],$[0]]),d=n?!0:t.is_primary,m=d?"primaryRoutePane":"alternativeRoutePane";let B;if(n)B=D[0];else{const $=b.filter(le=>!le.is_primary).length;B=t.is_primary?D[0]:D[$%(D.length-1)+1]}const k={color:B,weight:d?7:5,opacity:d?.95:.7,pane:m},c=L.polyline(u,k).addTo(a);b.push({polyline:c,routeData:t,id:s,is_primary:t.is_primary}),o.extend(c.getBounds()),c.bindPopup(`<b>${t.is_primary?"Rota Principal":"Alternativa"}</b><br>Distância: ${t.distance_km} km<br>Duração: ${t.duration_formatted}<br>Preço (${t.category_name}): ${t.currency_symbol||"R$"} ${t.calculated_price.toFixed(2).replace(".",",")}`),c.on("click",function($){L.DomEvent.stopPropagation($),X(t)})}}),o.isValid()&&a.flyToBounds(o,{padding:[50,50],duration:1.5})}async function re(e){if(!a){console.error("Objeto map não inicializado antes de fetchAndDisplayPriceQuote");return}if(!e||!r||!l){P.textContent="Defina origem, destino e selecione uma modalidade.";return}S(!0,"Calculando preço e rotas..."),T();try{const n=await fetch("/api/price-quote",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]')?document.querySelector('meta[name="csrf-token"]').getAttribute("content"):""},body:JSON.stringify({origin_lat:r.lat,origin_lon:r.lon,destination_lat:l.lat,destination_lon:l.lon,category:e})}),o=await n.json();if(n.ok&&o.routes&&o.routes.length>0){p=o.routes.map((i,s)=>({...i,id:i.id||`route-idx-${Date.now()}-${s}`}));const t=p.find(i=>i.is_primary)||p[0];X(t),Y([t],!0),t.toll_points&&t.toll_points.length>0&&t.toll_points.forEach(i=>{const s=L.marker([i.lat,i.lon],{icon:oe}).addTo(a).bindPopup(`Pedágio: ${i.name||"Informação não disponível"}`);z.push(s)}),y&&y.setPopupContent(`<b>Origem:</b><br>${r.displayName}`).openPopup(),g&&g.setPopupContent(`<b>Destino:</b><br>${l.displayName}`),p.length>1?(C.style.display="block",_.textContent=`${p.length-1} rota(s) alternativa(s) disponível(is).`):(C.style.display="none",_.textContent="Apenas uma rota principal encontrada.",t.toll_points&&t.toll_points.length>0&&(_.textContent+=` Contém ${t.toll_points.length} pedágio(s) identificado(s).`))}else if(o.errors){let t="Erros: ";for(const i in o.errors)t+=`${o.errors[i].join(", ")} `;P.textContent=t}else o.error?P.textContent=`Erro: ${o.error}`:P.textContent="Erro ao calcular cotação (status: "+n.status+")"}catch(n){console.error("Erro ao buscar cotação:",n),P.textContent=n.message||"Ocorreu um erro ao buscar a cotação."}finally{S(!1)}}C&&C.addEventListener("click",function(){p.length>0&&(Y(p,!1),_.textContent=`Mostrando todas as ${p.length} rotas. Clique nelas no mapa para detalhes.`,p[0].toll_points&&p[0].toll_points.length>0&&(_.textContent+=` A rota principal contém ${p[0].toll_points.length} pedágio(s) identificado(s).`),this.style.display="none")}),f.disabled=!0});
